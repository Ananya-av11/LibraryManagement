<!-- rentbookinfo.html -->
 <!-- <h3 style="text-align: center; margin-top: 20px; margin-bottom: 20px;">Rent Your Book</h3>
<div class="container-fluid mb-3" >
    {% if rentitems %}
    <div class="table-responsive">
        <form action="" method="POST" enctype="multipart/form-data">
        <table class="table table-bordered table-hover" >
            <tr class="bg-dark text-light text-center">
                <th>Image</th>
                <th>Book Name</th>
                <th>Author</th>
                <th>Publisher ID</th>
                <th>Rental Period</th>
                <th>Due Date</th>
                <th>Quantity</th>
                <th>Action</th>
            </tr>
            {% for item in rentitems %}
            <tr class="text-center">
                <td><img src="{{item.book.bookimage.url}}" alt="" width="75" height="75"></td>
                <td>{{item.book.bookname}}</td>
                <td>{{item.book.authorname}}</td>
                <td>{{item.book.publisher_id}}</td>
                <td>
                    <select name="rental_period_{{ item.id }}" class="form-control">
                        <option value="7" {% if item.duedate == item.rentaldate|add:"7" %}selected{% endif %}>1 Week</option>
                        <option value="14" {% if item.duedate == item.rentaldate|add:"14" %}selected{% endif %}>2 Weeks</option>
                        <option value="30" {% if item.duedate == item.rentaldate|add:"30" %}selected{% endif %}>1 Month</option>
                    </select>
                </td>
                <td>{{item.duedate}}</td>
                <td><button class="btn btn-outline-secondary"><a href="" >-</a></button>
                    <span class="mx-2">{{ item.quantity }}</span>
                    <button class="btn btn-outline-secondary"><a href="">+</a>
                </td>
                <td>
                    <a href="" class="btn btn-danger">Remove</a>
                </td>
            </tr>
            {% endfor %}
        </table>
        </form>
    </div>
    {% endif %}
</div> -->



<!-- allbooks.html -->
 <!-- {% extends 'userhome.html' %}
{% block content %}

<div class="container">
    {% if book %}
    <h3 style="text-align: center; margin-top: 20px; margin-bottom: 20px;">Books</h3>
    <div class="row row-cols-1 row-cols-lg-3 row-cols-md-2 row-cols-sm-2 row-cols-xl-4">
    {% for i in book %}
    <div class="col-md-4 mb-4">
    <div class="card">
        <img class="card-img-top" src="{{i.bookimage.url}}" alt="Card Image Cap" width="60px" height="200px">
        <div class="card-body">
            <h5 class="card-title">{{i.bookname}}</h5>
            <h6 class="card-text">{{i.authorname}}</h6>
            <p class="card-text">{{i.description}} <br> {{i.publisher_id}}</p>
            <h6 class="mb-3">₹ {{i.price}}</h6>
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-success"><a href="{% url 'rent_book' i.id %}" class="text-white" style="text-decoration: none;">Rent</a></button>
                <button class="btn btn-success"><a href="" class="text-white" style="text-decoration: none;">Purchase</a></button>
            </div>
        </div>
    </div>
    </div>
    {% endfor %}
    </div>
    
    {% else %}
    <div style="width: 100%; height: 400px;">
    <p class="text-center mt-5"><b>No Books Available</b></p>
    </div>
    {% endif %}
    </div>

{% endblock %} -->






<!-- updated allbooks -->
 <!-- {% extends 'userhome.html' %}
{% block content %}

<div class="container">
    <h3 class="text-center mt-3 mb-3">Available Books</h3>

    {% if book %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        {% for i in book %}
        <div class="col">
            <div class="card h-100 shadow-sm">
                <img src="{{ i.bookimage.url }}" class="card-img-top" alt="Book Image" style="height: 250px; object-fit: cover;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ i.bookname }}</h5>
                    <h6 class="card-text">{{ i.authorname }}</h6>
                    <p class="card-text">{{ i.description }} <br>₹{{ i.price }} <br>Stock: {{ i.stock }}</p>
                    
                    {% if i.stock > 0 %}
                    <form action="{% url 'rent_book' %}" method="post" class="mt-auto">
                        {% csrf_token %}
                        <input type="hidden" name="book_id" value="{{ i.id }}">

                        <label for="rental_period"><strong>Rental Period:</strong></label>
                        <select name="rental_period" class="form-select mb-2">
                            <option value="7">1 Week</option>
                            <option value="14">2 Weeks</option>
                            <option value="30">1 Month</option>
                        </select>

                        <label for="quantity"><strong>Quantity:</strong></label>
                        <input type="number" name="quantity" class="form-control mb-2" value="1" min="1" max="{{ i.stock }}">

                        <button type="submit" class="btn btn-success w-100">Rent</button>
                    </form>
                    {% else %}
                    <button class="btn btn-danger w-100 mt-auto" disabled>Out of Stock</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center"><b>No Books Available</b></p>
    {% endif %}
</div>

{% endblock %}
 -->


 def rent_book(request,pk):
    book=Books.objects.get(id=pk)
    rental_period=int(request.POST.get('rental_period'))
    quantity=int(request.POST.get('quantity',1))
    rental_date=timezone.now().date()
    due_date=rental_date+timedelta(days=rental_period)
    if book.stock < quantity:
        messages.error(request,f'Only {book.stock} copies available for {book.bookname}')
        return redirect('allbooks')
    rental,created = Rental.objects.get_or_create(user=request.user,book=book,defaults={'rentaldate':rental_date,'duedate':due_date,'quantity':quantity})
    if not created:
        if book.stock >= rental.quantity+quantity:
            rental.quantity+=quantity
            rental.duedate=due_date
            rental.save()
        else:
            messages.error(request,f'Only {book.stock} copies available for {book.bookname}')
            return redirect('allbooks')
    book.stock-=1
    book.save()
    messages.success(request,f"You have rented '{book.bookname}' until {due_date}.")
    return redirect('rentbookinfo')
    return render(request,'rentbookinfo.html',{'book':book})


    <!-- @login_required(login_url='loginpage')
def rentcart(request):
    purchase_items=Purchase.objects.filter(user=request.user,purchasestatus=0).select_related('book')
    total_purchase=purchase_items.count()
    rent_items=Rental.objects.filter(user=request.user,returned=0,lost=0).select_related('book')
    total_rent=rent_items.count()
    return render(request,'rentcart.html',{'rentitems':rent_items,'ptotal':total_purchase,'rtotal':total_rent})
def decrement_r(request,pk):
    rent_item=Rental.objects.get(user=request.user,id=pk)
    if rent_item.quantity > 1:
        rent_item.quantity -=1
        rent_item.save()
    else:
        rent_item.delete()
    return redirect(rentcart)
def increment_r(request,pk):
    rent_item=Rental.objects.get(user=request.user,id=pk)
    if rent_item.quantity < rent_item.book.stock:
        rent_item.quantity += 1
        rent_item.save()
    else:
        messages.error(request,f'Cannot add more. Only {rent_item.book.stock} copies available')
    return redirect('rentcart')
def remove_r(request,pk):
    rent_item=Rental.objects.get(user=request.user,id=pk)
    rent_item.delete()
    return redirect('rentcart') -->

    <script>
        window.onload = function() {
        $('#overdueModal').modal('show');
    };

    // $(document).ready(function () {
    //     // When the overdue modal is closed
    //     $('#overdueModal').on('hidden.bs.modal', function () {
    //         // Hide the badge in the "Rental History" link
    //         $('.nav-link[href*="rentalbooks"] .badge').hide();
    //     });
    // });

    $(document).ready(function () {
        // Check if badge should be hidden
        if (localStorage.getItem("hideRentalBadge") === "true") {
            $('.nav-link[href*="rentalhistory"] .badge').hide();
        }

        // Hide badge when navigating to purchase history
        if (window.location.href.includes("purchasehistory")) {
            $('.nav-link[href*="rentalhistory"] .badge').hide();
            localStorage.setItem("hideRentalBadge", "true"); // Save state
        }
    });

    </script>


rental_items=Rental.objects.all()
    overdue_alert=[]
    count=0
    for item in rental_items:
        if not item.returned and item.duedate < now().date():
            if item.lost:
                lostfine=item.book.price+200
            else:
                lostfine=0
            overdue_days=(now().date()-item.duedate).days
            fine_amount=overdue_days*10
            item.fine=fine_amount+lostfine
            item.save()
            count+=1
            overdue_alert.append({'user':f"{item.user.first_name} {item.user.last_name}",
                                  'book':item.book.bookname,
                                  'overdue_days':overdue_days,
                                  'fine':fine_amount})



def rent_info(request,pk):
book=Books.objects.get(id=pk)
if request.method == 'POST':
    period=int(request.POST['rental_period'])
    quantity=int(request.POST['quantity'])
    rental_date=timezone.now().date()
    due_date=rental_date+timedelta(days=period)
    rental,created = Rental.objects.get_or_create(user=request.user,book=book,rentaldate=rental_date,duedate=due_date,quantity=quantity)
    if not created:
        if book.stock >= rental.quantity+quantity:
            rental.quantity+=quantity
            rental.duedate=due_date
            rental.save()
        else:
            messages.error(request,f'Only {book.stock} copies available for {book.bookname}')
            return redirect('allbooks')
    return redirect('rentalhistory')
return render(request,'allbooks.html')


def purchase_book(request,pk):
    book=Books.objects.get(id=pk)
    if book.stock <= 0:
        messages.error(request,'Sorry, This book is out of stock')
        return redirect('allbooks')
    purchase_item, created=Purchase.objects.get_or_create(user=request.user,book=book,purchasedate=timezone.now(),purchasestatus=0)    
    if not created:
        purchase_item.quantity += 1
        purchase_item.purchasestatus=0
    purchase_item.save()
    # book.stock -=1
    # book.save()
    return redirect('purchasecart')